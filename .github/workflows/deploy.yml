services:
  web:
    build:
      dockerfile: Dockerfile
      context: .

    env:
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: ${RAILWAY_STATIC_URL}

      DB_CONNECTION: mysql
      DB_HOST: ${MYSQLHOST}
      DB_PORT: ${MYSQLPORT}
      DB_DATABASE: ${MYSQLDATABASE}
      DB_USERNAME: ${MYSQLUSER}
      DB_PASSWORD: ${MYSQLPASSWORD}

      CACHE_DRIVER: file
      SESSION_DRIVER: file
      QUEUE_CONNECTION: sync

    # ðŸ‘‡ Force override of the default "php-fpm" entrypoint
    entrypoint: ["/bin/sh", "-c"]

    start:
      cmd: >
        "composer install --no-dev --optimize-autoloader &&
         php artisan key:generate --force &&
         php artisan migrate --force &&
         php artisan serve --host=0.0.0.0 --port=80"

    healthcheck:
      path: /
      interval: 10
      timeout: 5
      retries: 3
